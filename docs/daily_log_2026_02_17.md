# Daily Log - 2026-02-17 (Tuesday)

## Scope
Pre-market and open-session operational validation for XSP 0DTE paper workflow, including:
- process hygiene,
- config/runtime validation,
- pre-open monitor smoke checks,
- one end-to-end paper execution attempt (open/close),
- journal integrity validation.

## Environment
- Repo: `scratch/ingresarios_options_research`
- Branch: `main` (clean/aligned at start)
- Mode used: Paper (`run_live_monitor.py` without `--live`)
- Entry gate config: `entry_time=10:00`

## Timeline (ET)

### 09:28 - Pre-open smoke (`--no-trade`)
- Started monitor in no-trade mode for startup validation.
- Confirmed runtime logs:
  - `HOLD_TO_EXPIRY_MODE=True (tp_pct=1.00)`
  - `TP=1.00 | SL=2.0x | Width=2.0`
  - `Expected commissions: win=$2.60 | loss=$5.20`
  - `Kill Switches: L1 ON, L3 ON (VIX>30), L5 ON`
  - startup reconciliation found no existing positions.
- Stopped process cleanly; removed stale lock when needed.

### 09:36 - Paper operational start (real trading path)
- Started `run_live_monitor.py` (paper, not no-trade).
- Confirmed warmup gate behavior:
  - `Waiting until 10:00 AM...`
- Confirmed process lock and startup config prints were present.

### 09:41 - Process cleanup request
- User requested full stop.
- Killed bot Python processes and removed `bot.lock`.
- Verified no bot processes running and lock absent.

### 09:46 - Journal preparation for auditable test
- Backed up journal:
  - `data/archive/trade_journal_pretest_20260217_094612.csv`
- Reset active journal to clean file:
  - `data/trade_journal.csv` recreated with headers only.

### 09:46-09:47 - Test Trade Attempt #1 (paper, scanner setup, normal floor)
- Connected to paper successfully.
- Scanner found setup:
  - Spot `682.61`, VIX `21.45`
  - Strikes `673P / 689C`
  - Estimated net credit `0.23`
- `execute_iron_condor` returned `None` (no fill).
- Failure mode:
  - chase loop hit credit floor:
    - stopped at `credit 0.18 < min_credit 0.20`
  - observed IBKR cancel race warning `10148` on pending cancel.
- No position opened in this attempt.

### 09:48-09:51 - Test Trade Attempt #2 (paper, test-only in-memory floor override)
- For workflow testing only (no file changes), runtime override:
  - `executor.config['min_credit'] = 0.05`
- Scanner found setup:
  - Spot `681.89`, VIX `21.71`
  - Strikes `673P / 688C`
- Trade opened successfully:
  - Journal logged `trade_id=1`
  - Fill credit observed around `0.19` per contract.
- Immediate close attempt failed:
  - Atomic BAG close failed.
  - Individual-leg fallback also failed.
  - Repeated IB/TWS errors seen:
    - `10349` (TIF/preset-related cancellation behavior)
    - `201` permission rejection in fallback path (`options strategy` context)
- Post-attempt state (captured then):
  - 4 XSP legs remained open:
    - `673P -1`
    - `688C -1`
    - `671P +1`
    - `690C +1`
- Journal remained with one OPEN row (no close record written because close failed).

### 09:52-09:54 - Recovery Attempt (combo close via script)
- Cancelled open orders first.
- Attempted aggressive BAG limit chase across multiple prices.
- No fill achieved; final rejection included:
  - `Error 201: Riskless combination orders are not allowed.`
- Positions remained open at that point.

### ~09:55 onward - User manual intervention
- User started manual close process in TWS.
- Automated leg-close script run was interrupted by user.
- Final read-only connectivity snapshot attempt later returned:
  - `Error 1100: Connectivity between IBKR and Trader Workstation has been lost`
  - requests timed out.
- Therefore final broker-side post-manual state was not programmatically confirmed in this session after manual intervention began.

## Journal Status (local file)
- File: `data/trade_journal.csv`
- Current content at last read:
  - `rows=1`
  - single row `trade_id=1` with `status=OPEN`
  - `exit_reason/final_pnl_usd` empty (expected if close did not complete via bot path)

## Artifacts Generated
- Startup/no-trade logs:
  - `outputs/preopen_no_trade_20260217_092838.err.log`
- Paper run logs:
  - `outputs/paper_live_20260217_093618.err.log`
  - `outputs/paper_live_unbuf_20260217_093708.log`
  - `outputs/paper_live_unbuf_20260217_093708.err.log`
- Journal backup:
  - `data/archive/trade_journal_pretest_20260217_094612.csv`

## Key Findings
1. Startup path and risk config loading are working as expected.
2. Pre-10:00 warmup gate works correctly.
3. End-to-end execution path can open a paper position.
4. Immediate close path is currently fragile in this environment due to IB/TWS order handling/rejections (`10349`, `201`).
5. Journal OPEN logging is reliable; CLOSE logging depends on successful close path.

## Operational Risk Note
- A test position was opened and close automation failed in-session.
- User took manual control to close.
- Broker connectivity later returned `1100`, so final automated verification of flat state is pending.

## Pending Follow-up (next session)
1. Confirm broker is flat (XSP positions and open orders = 0).
2. Reconcile local journal row `trade_id=1` with actual manual close outcome.
3. Capture exact TWS preset/permission settings tied to `10349` and combo close behavior.
4. Re-run controlled paper test only after close-path fix plan is approved.

### 10:28 - Monitoreo activo de posicion abierta (reanudado)
- Proceso detectado en ejecucion: `python -u run_live_monitor.py --no-trade` (PID 20768).
- `state.json` cargado con `trade_id=1` y 4 patas XSP; recuperacion de posicion confirmada por el bot.
- Snapshot actual del monitor:
  - `[10:27:48] XSP: 679.24 | VIX: 22.5 | PnL: $-5.53 (-24%Max) | TP:-24% SL:12% | 673P(+6) 688C(+9) | Hold:38m | MaxSprd:0.29`
- Modo operativo:
  - Sin apertura de nuevas operaciones (`--no-trade`).
  - Se mantiene la posicion abierta y solo se vigilan salidas por SL/EOD.

### 10:31 - Update monitor (+3 min)
- Resumen ventana 3 min: inicio 10:28:43 -> fin 10:31:38 | XSP 678.47 | VIX 22.7 | PnL ult=-3.64 rango=[-5.53, -3.64]
- Estado: posicion sigue abierta; sin evento de cierre detectado en log.


### 10:34 - Update monitor (+3 min)
- Resumen ventana 3 min: inicio 10:32:00 -> fin 10:33:17 | XSP 678.19 | VIX 22.8 | PnL ult=-4.50 rango=[-4.50, -4.50]
- Estado: posicion sigue abierta; sin evento de cierre detectado en log.


### 10:35 - Update monitor (+3 min, riesgo elevado)
- El proceso de monitoreo sigue corriendo (PID 20768) y escribiendo log.
- Se detectaron multiples ticks con bandera DANGER por acercamiento al short put.
- Ultimo snapshot:
  - ⚠️ DANGER [10:34:55] XSP: 677.77 | VIX: 22.9 | PnL: $-9.69 (-42%Max) | TP:-42% SL:21% | 673P(+5) 688C(+10) | Hold:45m | MaxSprd:0.33
- Estado: posicion abierta; sin trigger de cierre ejecutado.


### 10:38 - Update monitor (+3 min)
- Resumen ventana 3 min: inicio 10:35:39 -> fin 10:38:23 | XSP 677.89 | VIX 22.9 | PnL ult=-5.29 rango=[-9.69, -5.29]
- Riesgo intraminuto: 2/16 ticks con DANGER
- Estado: posicion sigue abierta; sin evento de cierre detectado en log.


### 10:42 - Update monitor (+3 min)
- Resumen ventana 3 min: inicio 10:39:18 -> fin 10:42:14 | XSP 677.64 | VIX 22.9 | PnL ult=-5.47 rango=[-5.47, -5.29]
- Riesgo intraminuto: 12/17 ticks con DANGER
- Estado: posicion sigue abierta; sin evento de cierre detectado en log.


### 10:46 - Update monitor (+3 min)
- Resumen ventana 3 min: inicio 10:43:19 -> fin 10:46:06 | XSP 678.73 | VIX 22.4 | PnL ult=-5.27 rango=[-5.47, -5.27]
- Riesgo intraminuto: 7/16 ticks con DANGER
- Estado: posicion sigue abierta; sin evento de cierre detectado en log.


### 10:52 - Update monitor (+3 min)
- Resumen ventana 3 min: inicio 10:49:12 -> fin 10:51:57 | XSP 679.93 | VIX 22.2 | PnL ult=3.70 rango=[-0.61, 3.70]
- Riesgo intraminuto: 0/16 ticks con DANGER
- Estado: posicion sigue abierta; sin evento de cierre detectado en log.


### 10:54 - Update monitor (+3 min)
- Resumen ventana 3 min: inicio 10:51:24 -> fin 10:54:08 | XSP 679.55 | VIX 22.2 | PnL ult=3.08 rango=[3.08, 3.70]
- Riesgo intraminuto: 0/16 ticks con DANGER
- Estado: posicion sigue abierta; sin evento de cierre detectado en log.


### 10:56 - Update monitor (+3 min)
- Resumen ventana 3 min: inicio 10:53:24 -> fin 10:56:20 | XSP 679.8 | VIX 22.1 | PnL ult=6.59 rango=[3.08, 6.59]
- Riesgo intraminuto: 0/17 ticks con DANGER
- Estado: posicion sigue abierta; sin evento de cierre detectado en log.


### 10:57 - Update puntual solicitado (trade status)
- Snapshot: [10:57:14] XSP: 679.84 | VIX: 22.1 | PnL: $6.59 (29%Max) | 673P(+7) 688C(+8) | Hold:67m | MaxSprd:0.33
- Estado operativo:
  - Posicion sigue abierta (trade_id=1).
  - Sin trigger de salida ejecutado.
- Niveles de vigilancia de salida:
  - SL tecnico: PnL <= -$38 (entry_credit 0.19, SL 2x).
  - Zona de atencion por precio: cerca de short strikes; intensificar si XSP < 678 (lado put) o XSP > 683 (lado call).
  - Cierre por hora: revisar especialmente desde 15:45 ET (EOD close path).


### 11:24 - Update monitor (+30 min)
- Resumen ventana 30 min: inicio 11:15:01 -> fin 11:24:00 | XSP 684.7 | VIX 20.8 | PnL ult=-6.43 rango=[-7.38, -1.84]
- Riesgo intraminuto: 50/50 ticks con DANGER
- Estado: posicion sigue abierta; sin evento de cierre detectado en log.


### 11:54 - Update monitor (+30 min)
- Resumen ventana 30 min: inicio 11:24:11 -> fin 11:53:59 | XSP 683.82 | VIX 20.7 | PnL ult=6.73 rango=[-9.81, 7.80]
- Riesgo intraminuto: 153/164 ticks con DANGER
- Estado: posicion sigue abierta; sin evento de cierre detectado en log.


### 12:19 - Cierre inmediato solicitado por usuario
- Se detuvieron procesos de monitor y updater para evitar conflicto de ordenes.
- Intento 1 (scripts/emergency_close_all.py): rechazado por IBKR con errores 10349 y 201; no cerro patas.
- Intento 2 (scripts/emergency_flatten.py): cierre por patas con limites, 4/4 fills confirmados.
- Verificacion post-cierre:
  - scripts/check_positions.py -> No open positions found.
  - scripts/audit_current_positions.py -> NO OPEN POSITIONS y NO OPEN ORDERS.
- Estado final: cuenta DUO988990 en paper sin posiciones XSP abiertas (flat).

### 12:23 - Reconciliacion final de PnL y journal
- Se consultaron ejecuciones del broker para las 4 patas del condor (`673P`, `688C`, `671P`, `690C`).
- Apertura real por patas (09:49:51 ET): `+0.35 -0.24 +0.32 -0.15 = +0.28` credito.
- Cierre real por patas (12:17:57-12:18:48 ET): `-0.06 +0.03 -0.09 +0.01 = -0.11` debito neto.
- Resultado final:
  - `PnL bruto realizado = +$17.00`
  - `Comisiones totales (IBKR Trades Summary) = $9.84`
  - `PnL neto despues de comisiones = +$7.16`
- Journal reconciliado:
  - `data/trade_journal.csv` actualizado a `status=CLOSED` para `trade_id=1`.
  - `exit_reason=MANUAL_EMERGENCY_FLATTEN`, `final_pnl_usd=7.16`, `commissions_est=9.84`.
  - Backup previo guardado en `data/archive/trade_journal_pre_reconcile_20260217_122307.csv`.


# POST-MORTEM: Trade #1 (Test) — 2026-02-17

## Trade Identity

| Field | Value |
|-------|-------|
| Trade ID | 1 (TEST — no cuenta para Phase 1) |
| Date | 2026-02-17 (Tuesday) |
| Account | DUO988990 (Paper) |
| Status | CLOSED |
| Exit Method | MANUAL_EMERGENCY_FLATTEN |

---

## 1. Trade Structure

| Pata | Strike | Tipo | Open Fill | Close Fill |
|------|--------|------|-----------|------------|
| Long Put | 671 | Protección | -$0.24 | +$0.03 |
| **Short Put** | **673** | **Vendida** | **+$0.35** | **-$0.06** |
| **Short Call** | **688** | **Vendida** | **+$0.32** | **-$0.09** |
| Long Call | 690 | Protección | -$0.15 | +$0.01 |

- Wing width: 2
- Zona de profit: 673–688 (15 puntos)
- Spot al abrir: 681.89
- VIX al abrir: 21.71

---

## 2. PnL Reconciliado (Fuente: IBKR Trades Summary)

| Concepto | Valor |
|----------|-------|
| Crédito real apertura (suma patas) | **$0.28** ($28.00) |
| Débito real cierre (suma patas) | **$0.11** ($11.00) |
| **PnL bruto** | **+$17.00** |
| Comisiones totales (8 legs) | **-$9.84** |
| **PnL neto realizado** | **+$7.16** |

### Escenario contrafactual: hold to expiry

| Escenario | Bruto | Comisiones | Neto |
|-----------|-------|------------|------|
| Hold to expiry (ambos OTM) | $28.00 | $2.60 | **$25.40** |
| Cierre manual 12:19 ET (real) | $17.00 | $9.84 | **$7.16** |
| **Diferencia (dinero dejado en mesa)** | | | **$18.24 (72%)** |

---

## 3. DISCREPANCIA CRÍTICA: Crédito Bot vs Broker

| Fuente | Crédito reportado |
|--------|-------------------|
| Bot (journal entry_credit) | **$0.19** |
| Broker (suma de fills reales) | **$0.28** |
| Discrepancia | **+$0.09 (47% mayor)** |

**Impacto:** Todos los cálculos del monitor intradía (PnL, % de max profit, distancia a SL) estuvieron basados en $0.19, no en el crédito real de $0.28. El SL 2x debería haber sido -$0.56, no -$0.38.

**Root cause probable:** El bot captura el precio del combo fill (BAG order), que en paper trading no coincide con la suma de los fills individuales por pata. El simulador de IBKR es conocido por fills pobres en combos.

**Acción requerida (P0):** Implementar captura del crédito real post-fill verificando fills individuales por pata, no solo el precio reportado del combo.

---

## 4. Comisiones: Modelo vs Realidad

| Concepto | Estimado por bot | Real |
|----------|-----------------|------|
| Apertura (4 legs) | $2.60 | ~$4.92 |
| Cierre (4 legs) | $2.60 (combo) / $5.20 (patas) | ~$4.92 |
| **Total roundtrip** | **$5.20–$7.80** | **$9.84** |

**Fricción como % del profit bruto:** $9.84 / $17.00 = **58%**

**Fricción como % del max profit teórico:** $9.84 / $28.00 = **35%**

**Lección:** Con créditos de ~$0.28, las comisiones destruyen una proporción masiva del profit si se cierra antes de expiración. Hold-to-expiry (comisiones solo de apertura = $2.60) reduce fricción de 35% a 9%.

**Acción requerida (P1):** Refinar modelo de comisiones para contemplar:
- Cierre por patas individuales (~$1.23/leg) vs combo (~$1.30/4-legs)
- Comisiones reales de paper vs live (pueden diferir)

---

## 5. Perfil de Riesgo Intradía

### 5.1 Resumen de MAE/MFE

| Métrica | Valor | Nota |
|---------|-------|------|
| Max Adverse Excursion (MAE) | **-$9.81** | ~10:35 ET, put side amenazado |
| Max Favorable Excursion (MFE) | **+$7.80** | ~11:54 ET (bot estimate) |
| Rango PnL total observado | $17.61 | De -$9.81 a +$7.80 |
| SL trigger (2x crédito real) | -$56.00 | Nunca se acercó |
| % MAE sobre max loss ($200) | 4.9% | Trade bien controlado |

### 5.2 Migración de Riesgo

El riesgo migró completamente durante la sesión:

| Hora (ET) | Spot | Lado amenazado | Dist. a short strike | DANGER % |
|-----------|------|----------------|---------------------|----------|
| 10:35 | 677.77 | **Put (673)** | +4.77 pts | Alto |
| 10:52 | 679.93 | Neutro | Centrado | 0% |
| 11:24 | 684.70 | **Call (688)** | +3.30 pts | 100% |
| 11:54 | 683.82 | **Call (688)** | +4.18 pts | 93% |

**Observación clave:** A pesar del 93% de ticks en DANGER en la última ventana, el PnL se mantuvo positivo. Theta decay compensó la proximidad al short strike — el modelo funciona como fue diseñado.

### 5.3 Asimetría de la Posición (reportada en auditoría)

| Métrica | Put Side | Call Side |
|---------|----------|-----------|
| Short strike | 673 | 688 |
| Distancia OTM al abrir | 8.89 pts (1.30%) | 6.11 pts (0.90%) |
| Delta | 0.087 | 0.117 |
| IV | 39.7% | 29.9% |

El call side estuvo más cercano al money desde la apertura (0.90% vs 1.30%). Esto es inherente al skew de índice y al strike grid de XSP ($1 increments).

---

## 6. Issues Operacionales Documentados

### 6.1 Paper Trading — Combo Orders (P0 para decisión live)

| Evento | Error | Descripción |
|--------|-------|-------------|
| Apertura combo | Funcionó | BAG order se llenó |
| Cierre combo | **Error 201** | "Riskless combination orders not allowed" |
| Cierre combo retry | **Error 201** | Mismo rechazo |
| Cierre individual (emergency) | **Funcionó** | 4/4 patas cerradas individualmente |

**Diagnóstico:** El paper trading de IBKR tiene "Limited combo trading" documentado. El Error 201 ("no trading permissions for this options strategy") es una limitación del simulador, no de la cuenta (Level 3 confirmado en live).

**Implicación para live:** En live con Level 3, los combo close deberían funcionar. Pero se necesita un fallback robusto a cierre individual por si falla.

### 6.2 Violaciones de Modelo (este trade no es Phase 1 oficial)

| Parámetro | Requisito | Real | Violación |
|-----------|-----------|------|-----------|
| Entry time | ≥ 10:00 ET | 09:49 | **SÍ** (-11 min) |
| Min credit | ≥ $0.20 | $0.19 (bot) / $0.28 (real) | **SÍ** (override manual) |

**Nota:** El trade se abrió con override manual de `min_credit=0.05` para testing de workflow. En operación normal, el bot rechazó correctamente el intento #1 por crédito insuficiente ($0.18 < $0.20).

---

## 7. Validaciones Positivas

Lo que **funcionó correctamente**:

1. **Startup & config:** Kill switches L1/L3/L5 activos, HOLD_TO_EXPIRY_MODE confirmado
2. **Time gate:** Bot esperó hasta 10:00 AM (override fue manual, no fallo del gate)
3. **Min credit gate:** Rechazó correctamente intento #1 ($0.18 < $0.20)
4. **Strike selection:** Greeks y construction del IC correctos
5. **Journal OPEN logging:** Registro atómico al abrir posición
6. **Monitor loop:** PnL tracking, DANGER flags, distancia a strikes
7. **State recovery:** Bot reconectó y recuperó posición desde state.json
8. **Process lock:** bot.lock funcionó para single instance
9. **Emergency flatten:** Fallback a cierre individual operativo (4/4 fills)
10. **Reconciliación:** Journal actualizado con datos reales del broker

---

## 8. Action Items Pre-Live

### P0 (Must fix)

| # | Item | Descripción |
|---|------|-------------|
| 1 | **Credit capture real** | Post-fill, verificar crédito sumando fills individuales por pata, no confiar en precio de combo |
| 2 | **Combo close validation** | Probar cierre combo en live. Si falla, implementar fallback automático a cierre individual |
| 3 | **Paper vs Live decision** | Dado que paper no soporta combo close, evaluar si se migra directamente a live (Level 3 confirmado, risk = $200/trade max) |

### P1 (Should fix)

| # | Item | Descripción |
|---|------|-------------|
| 4 | **Commission model update** | Refinar estimados: combo close (~$1.30/4-leg) vs individual close (~$1.23/leg × 4 + 4 = 8 legs total) |
| 5 | **Close path robustness** | Implementar fallback automático: combo → individual legs, sin intervención manual |

### P2 (Nice to have)

| # | Item | Descripción |
|---|------|-------------|
| 6 | **MFE tracking** | Agregar Max Favorable Excursion al journal (complementa MAE) |
| 7 | **DANGER log aggregation** | Agregar % de ticks en DANGER al cierre como métrica de riesgo intradía |

---

## 9. Lecciones Clave

### 9.1 Cuantitativas
- **Hold-to-expiry es mandatorio** para créditos pequeños. Cerrar a las 12:19 costó $18.24 de ganancia potencial (72%).
- **Comisiones dominan** el P&L en créditos de ~$0.28. Roundtrip cierre temprano = 58% del profit bruto se va en fricción.
- **Theta decay funciona** exactamente como predice el modelo: el PnL se mantuvo positivo incluso con 93% de ticks en DANGER.
- **MAE de -$9.81 nunca amenazó el SL** (-$56 real). El trade absorbió volatilidad sin problema.

### 9.2 Operacionales
- **Paper trading tiene limitaciones reales** para combos. No es un reflejo fiel de la ejecución en live.
- **El crédito reportado por el bot puede diferir del real** — esto debe corregirse antes de live.
- **El fallback a cierre individual funciona** pero duplica comisiones.

### 9.3 Emocionales
- Se resistió el impulso de cerrar en el DANGER del put side (10:35, +$677.77) — correcto.
- Se cedió al impulso de cerrar con profit en el call side (~12:19) — costó $18.24.
- **Conclusión:** la disciplina del hold-to-expiry no es solo matemática, es gestión emocional. El modelo existe precisamente para eliminar decisiones discrecionales intradía.

---

## 10. Clasificación Final

| Dimensión | Evaluación |
|-----------|------------|
| **Validez para Phase 1** | NO (violó entry_time y min_credit) |
| **Valor como test de infraestructura** | ALTO (validó open/monitor/close/journal/reconcile) |
| **Uso para calibración iv_scaling_factor** | NO (datos contaminados por override y paper artifacts) |
| **Valor educativo** | MÁXIMO (primera exposición real a theta decay, DANGER zones, y costo emocional de salida temprana) |

---

*Generado: 2026-02-17 | Auditor: Claude (Quant Lead) | Fuentes: IBKR Trades Summary, trade_journal.csv, daily_log_2026_02_17.md*
